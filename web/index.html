<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Badger Face Anonymizer</title>
    <link id="favicon" rel="icon" href="logo-white.png" type="image/png"/>
    <link rel="shortcut icon" href="logo-white.png" type="image/png"/>
    <link rel="apple-touch-icon" href="logo-white.png"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#000000",
              "background-main": "#FFFFFF",
              "card-border": "#e5e7eb",
            },
            fontFamily: { "display": ["Space Grotesk", "sans-serif"] },
            borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
          },
        },
      }
    </script>
    <style>
      body { font-family: "Space Grotesk", sans-serif; }
      body.fullscreen { min-height: 100vh; display: flex; flex-direction: column; }
      body.fullscreen main { margin-top: auto; margin-bottom: auto; }
      #mobileSourceTabs { display: none; }
      .upload-circle { width: 64px; height: 64px; border-radius: 9999px; flex: 0 0 auto; aspect-ratio: 1 / 1; }
      @media (max-width: 640px) {
        html, body { overflow-y: auto; -webkit-overflow-scrolling: touch; height: auto; }
        html, body { scrollbar-width: none; -ms-overflow-style: none; }
        html::-webkit-scrollbar, body::-webkit-scrollbar { width: 0; height: 0; display: none; }
        header { padding-left: 16px !important; }
        #themeHeaderToggle { gap: 0.25rem; }
        #logoContainer { padding: 0.375rem; }
        main { padding: 16px 16px 56px !important; }
        #dropArea { padding-top: 24px !important; padding-bottom: 24px !important; }
        .upload-circle { width: 56px; height: 56px; margin-top: 8px; margin-bottom: 8px; }
        #dropArea button { margin-bottom: 12px; }
        .grid { gap: 12px !important; }
        .img-box { max-height: 50vh; }
        #sourceTabs { display: none; }
        #toastContainer {
          left: 50%;
          right: auto !important;
          transform: translateX(-50%);
          top: 72px;
          width: 20rem;
          align-items: center;
        }
        #toastContainer .toast { width: 100%; box-sizing: border-box; }
        #mobileSourceTabs {
          display: flex !important;
          position: static !important;
          margin: 8px auto 12px !important;
          left: auto !important;
          right: auto !important;
          transform: none !important;
          bottom: auto !important;
          z-index: auto !important;
          width: auto !important;
          max-width: min(92vw, 360px) !important;
          padding: 4px !important;
          gap: 0.5rem !important;
          flex-wrap: nowrap !important;
          overflow: hidden !important;
        }
        #mobileSourceTabs button {
          display: inline-flex !important;
          flex: 0 0 auto !important;
          white-space: nowrap !important;
        }
      }
      :root { --color-primary: #000000; }
      .dark { --color-primary: #ffffff; }
      :root { --on-primary: #ffffff; }
      .dark { --on-primary: #000000; }
      :root { --stripe-color: rgba(255, 255, 255, 0.35); }
      .dark { --stripe-color: rgba(0, 0, 0, 0.28); }
      .custom-dashed-border {
        border: 2px dashed #e5e7eb;
        border-radius: 0.5rem;
      }
      #sourceTabs, #mobileSourceTabs {
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
      }
      @supports not (gap: 0.5rem) {
        #sourceTabs { gap: 0 !important; }
        #sourceTabs > button { margin-right: 0.5rem; }
        #sourceTabs > button:last-child { margin-right: 0; }
        #mobileSourceTabs { gap: 0 !important; }
        #mobileSourceTabs > button { margin-right: 0.5rem; }
        #mobileSourceTabs > button:last-child { margin-right: 0; }
      }
      .img-box {
        position: relative;
        aspect-ratio: 16 / 9;
        height: auto;
        min-height: 240px;
        max-height: 60vh;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        background: #fafafa;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .img-box .bg-blur {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(24px);
        transform: scale(1.1);
        opacity: 0.35;
      }
      .img-box .img-main {
        position: relative;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 0.5rem;
      }
      #headerLogo { transition: filter 160ms ease; }
      .dark #headerLogo { filter: invert(1); }
      @media (prefers-color-scheme: dark) {
        #anonymizeIcon { filter: invert(0); }
      }
      @media (prefers-color-scheme: light) {
        #anonymizeIcon { filter: invert(1); }
      }
      #themeHeaderToggle { cursor: pointer; }
      #anonymizeIcon { transition: filter 160ms ease; filter: invert(1); }
      .dark #anonymizeIcon { filter: invert(0); }
      #procDots { display: inline-block; width: 3ch; margin-left: -0.2ch; }
      #procDots .dot { visibility: hidden; }
      #intensityRange {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        height: 6px;
        background: #e5e7eb;
        border-radius: 9999px;
        outline: none;
        transition: background 160ms ease;
        margin-top: 6px;
        vertical-align: middle;
      }
      .dark #intensityRange { background: #374151; }
      #intensityRange::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--color-primary);
        margin-top: -8px;
        border: none;
        box-shadow: none;
        transition: none;
        transform: none;
      }
      .dark #intensityRange::-webkit-slider-thumb { }
      #intensityRange:hover::-webkit-slider-thumb { transform: none; }
      #intensityRange:active::-webkit-slider-thumb { transform: none; }
      #intensityRange::-moz-range-thumb {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--color-primary);
        border: none;
        box-shadow: none;
        transition: none;
        transform: none;
      }
      .dark #intensityRange::-moz-range-thumb { }
      #intensityRange:hover::-moz-range-thumb { transform: none; }
      #intensityRange:active::-moz-range-thumb { transform: none; }
      #intensityRange::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 9999px;
      }
      #intensityRange::-moz-range-track {
        height: 6px;
        border-radius: 9999px;
        background: transparent;
        border: none;
      }
      @media (min-width: 768px) {
        #intensityRange {
          flex: 0 0 140px !important;
          width: 140px !important;
        }
      }
      .drop-active { border-color: var(--color-primary); background: rgba(0, 0, 0, 0.06); }
      .dark .drop-active { border-color: var(--color-primary); background: rgba(255, 255, 255, 0.12); }
      .drop-active .size-16 { transform: scale(1.06); }
      .dark .custom-dashed-border { border-color: #374151; }
      .dark .img-box { border-color: #374151; background: #0f172a; }
      .log-panel {
        max-height: 180px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: #fbfbfb;
        padding: 0.75rem;
      }
      .dark .log-panel {
        border-color: #374151;
        background: #0b1220;
      }
      .ant-shadow {
        box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.08), 0 3px 6px -4px rgba(0, 0, 0, 0.12), 0 9px 28px 8px rgba(0, 0, 0, 0.05);
      }
      .toast-enter { transform: translateY(-8px); opacity: 0; }
      .toast-enter-active { transform: translateY(0); opacity: 1; transition: transform 240ms cubic-bezier(0.22, 1, 0.36, 1), opacity 240ms ease-out; }
      .toast-exit { transform: translateY(0); opacity: 1; }
      .toast-exit-active { transform: translateY(-8px); opacity: 0; transition: transform 200ms ease, opacity 200ms ease; }
      .toast { outline: none; }
      .toast:focus-visible { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.35); border-radius: 0.5rem; }
      .toast-body { word-break: break-word; }
      .bg-success { background-color: #52c41a; }
      .text-success { color: #52c41a; }
      .bg-error { background-color: #ff4d4f; }
      .text-error { color: #ff4d4f; }
      .bg-warning { background-color: #faad14; }
      .text-warning { color: #faad14; }
      .bg-info { background-color: var(--color-primary); }
      .text-info { color: var(--color-primary); }
      .bg-primary { background-color: var(--color-primary) !important; }
      .text-primary { color: var(--color-primary) !important; }
      .text-on-primary { color: var(--on-primary) !important; }
      button:focus, button:focus-visible { outline: none !important; box-shadow: none !important; }
      #sourceTabs button:focus, #sourceTabs button:focus-visible { outline: none !important; box-shadow: none !important; }
      #themeBtn:focus, #themeBtn:focus-visible { outline: none !important; box-shadow: none !important; }
      @keyframes spinOnce { to { transform: rotate(360deg); } }
      .spin-once { display: inline-block; animation: spinOnce 600ms linear; will-change: transform; }
      @keyframes stripeMove { from { background-position: 0 0; } to { background-position: 40px 0; } }
      .bar-stripes { background-image: linear-gradient(45deg, var(--stripe-color) 25%, transparent 25%, transparent 50%, var(--stripe-color) 50%, var(--stripe-color) 75%, transparent 75%, transparent); background-size: 40px 40px; animation: stripeMove 600ms linear infinite; }
      .tab-indicator {
        transition:
          left 320ms cubic-bezier(0.22, 1, 0.36, 1),
          top 320ms cubic-bezier(0.22, 1, 0.36, 1),
          width 320ms cubic-bezier(0.22, 1, 0.36, 1),
          height 320ms cubic-bezier(0.22, 1, 0.36, 1),
          background-color 200ms ease;
        will-change: left, top, width, height;
      }
      #typeMenu {
        position: absolute;
        left: 0;
        right: 0;
        bottom: calc(100% + 6px);
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.08), 0 3px 6px -4px rgba(0, 0, 0, 0.12), 0 9px 28px 8px rgba(0, 0, 0, 0.05);
        display: none;
        z-index: 50;
        overflow: hidden;
      }
      .dark #typeMenu {
        background: #0b1220;
        border-color: #374151;
        box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.35), 0 3px 6px -4px rgba(0, 0, 0, 0.45), 0 9px 28px 8px rgba(0, 0, 0, 0.35);
      }
      .select-open #typeMenu { display: block; }
      #typeMenu li {
        padding: 10px 12px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #0f172a;
        cursor: pointer;
      }
      .dark #typeMenu li { color: #e5e7eb; }
      #typeMenu li:hover, #typeMenu li:focus {
        background-color: var(--color-primary);
        color: var(--on-primary);
      }
      @keyframes sunToggle {
        0% { transform: rotate(0deg) scale(1); opacity: 0.8; }
        50% { transform: rotate(15deg) scale(1.1); opacity: 1; }
        100% { transform: rotate(0deg) scale(1); opacity: 1; }
      }
      @keyframes moonToggle {
        0% { transform: rotate(0deg) scale(1); opacity: 0.8; }
        50% { transform: rotate(-15deg) scale(1.1); opacity: 1; }
        100% { transform: rotate(0deg) scale(1); opacity: 1; }
      }
      .sun-toggle-anim { animation: sunToggle 320ms ease-out; }
      .moon-toggle-anim { animation: moonToggle 320ms ease-out; }
      @keyframes themeRipple {
        0% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.24); }
        100% { box-shadow: 0 0 0 12px rgba(0, 0, 0, 0); }
      }
      .theme-ripple { animation: themeRipple 420ms ease-out; }
      html, body, header, main, .img-box, .glass-panel {
        transition:
          background-color 320ms cubic-bezier(0.22, 1, 0.36, 1),
          color 320ms cubic-bezier(0.22, 1, 0.36, 1),
          border-color 320ms cubic-bezier(0.22, 1, 0.36, 1);
      }
      .select-arrow { transition: transform 240ms cubic-bezier(0.22, 1, 0.36, 1); will-change: transform; transform: translateY(-50%) rotate(0deg); }
      .select-open .select-arrow { transform: translateY(-50%) rotate(180deg); }
      #typeSelectBtn[aria-expanded="true"] .select-arrow { transform: translateY(-50%) rotate(180deg); }
      #typeSelect { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none; }
      #typeSelect::-ms-expand { display: none; }
      .control-label { display: inline-block; line-height: 1; margin-left: 0; }
      #intensityLabel { position: relative; top: 2px; }
      #fastModeToggle { accent-color: var(--color-primary) !important; }
      #fastModeToggle:focus { outline: none; box-shadow: none; }
      #fastModeToggle:focus-visible { outline: none; box-shadow: none; }
      input[type="checkbox"], input[type="radio"], input[type="range"] { accent-color: var(--color-primary) !important; }
      #fastModeToggle {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 1.5rem;
        height: 1.5rem;
        border: 1px solid var(--color-primary);
        border-radius: 0;
        background-color: transparent;
        background-image: none !important;
        position: relative;
        transition: background-color 160ms ease, border-color 160ms ease;
      }
      #fastModeToggle { border-color: #e5e7eb; }
      .dark #fastModeToggle { border-color: #374151; }
      #fastModeToggle:checked {
        background-color: var(--color-primary);
        background-image: none !important;
      }
      #fastModeToggle:checked::after {
        content: "";
        position: absolute;
        width: 7px;
        height: 10px;
        border: 2px solid var(--on-primary);
        border-top: none;
        border-left: none;
        transform: translate(-50%, -60%) rotate(45deg);
        left: 50%;
        top: 50%;
      }
    </style>
  </head>
  <body class="bg-background-main text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen">
    <div class="layout-container flex h-full grow flex-col">
      <header class="grid grid-cols-[1fr_auto_1fr] items-center whitespace-nowrap border-b border-solid border-slate-200 dark:border-slate-700 px-12 lg:px-20 py-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-50">
        <div id="themeHeaderToggle" class="flex items-center gap-1">
          <div id="logoContainer" class="p-2 flex items-center justify-center">
            <img id="headerLogo" src="logo.png" alt="Face Anonymizer" class="h-12 w-12 object-contain" title="Face Anonymizer" />
          </div>
          <h2 class="text-xl font-bold leading-tight tracking-tight text-slate-900 dark:text-slate-100">Face Anonymizer</h2>
        </div>
        <div class="flex items-center justify-center justify-self-center">
          <div id="sourceTabs" class="relative flex items-center gap-2 rounded-full bg-white/70 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-700 p-1 shadow-sm backdrop-blur-sm transition-colors">
            <span id="tabIndicator" class="absolute rounded-full bg-primary tab-indicator" style="z-index:0; top:0; left:0; height:0; width:0;"></span>
            <button id="tabImage" class="px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center">Image</button>
            <button id="tabVideo" class="px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center">Video</button>
          </div>
        </div>
        <div class="flex items-center gap-4 justify-self-end">
          <button id="themeBtn" class="relative overflow-hidden flex items-center justify-center rounded-lg h-10 w-10 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800 transition-colors" title="Theme">
            <span id="themeIcon" class="material-symbols-outlined">light_mode</span>
          </button>
        </div>
      </header>
      <div id="mobileSourceTabs" class="relative flex items-center gap-2 rounded-full bg-white/70 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-700 p-1 shadow-sm backdrop-blur-sm">
        <span id="tabIndicatorMobile" class="absolute rounded-full bg-primary tab-indicator" style="z-index:0; top:0; left:0; height:0; width:0;"></span>
        <button id="tabImageMobile" class="px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center">Image</button>
        <button id="tabVideoMobile" class="px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center">Video</button>
      </div>
      <main class="max-w-[1200px] mx-auto w-full p-4 lg:p-8">
        <div class="flex flex-col gap-1.5 mb-2">
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-slate-900 dark:text-slate-100">Badger Face Anonymizer</h1>
          <p class="text-slate-600 text-base max-w-xl mb-4">
            High-performance face detection and obfuscation tool. Securely process images and videos on your device — no cloud upload.
          </p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-7 mb-7">
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between px-2">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">upload_file</span>
                <h3 id="inputHeading" class="text-lg font-bold text-slate-900 dark:text-slate-100">Input Images</h3>
              </div>
              <span class="text-xs font-semibold bg-primary/10 text-primary px-2.5 py-1 rounded-full uppercase tracking-wider">Source</span>
            </div>
            <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm flex flex-col min-h-[360px] glass-panel dark:bg-slate-800">
              <div class="flex-1 p-8 flex flex-col">
                <div id="dropArea" class="flex-1 img-box custom-dashed-border bg-slate-50 dark:bg-slate-900 transition-all cursor-pointer flex flex-col items-center justify-center gap-4 text-center p-8">
                  <div class="upload-circle bg-slate-200 text-slate-600 flex items-center justify-center transition-transform">
                    <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Click or drag image to upload</p>
                    <p class="text-xs text-slate-500 mt-1">Supports JPG, PNG, WEBP, BMP, TIFF (Max 10MB)</p>
                  </div>
                  <button id="browseBtn" class="mt-2 bg-primary hover:bg-primary/90 text-on-primary px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md">
                    Browse Images
                  </button>
                  <input id="fileInput" type="file" accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff" class="hidden" />
                </div>
              </div>
              <div class="px-6 h-16 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <span id="statusText" class="text-xs text-slate-500 italic">No file selected</span>
                <div class="flex gap-2">
                  <span class="size-2 rounded-full bg-slate-200"></span>
                  <span class="size-2 rounded-full bg-slate-200"></span>
                  <span class="size-2 rounded-full bg-slate-200"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between px-2">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-green-600">verified_user</span>
                <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100">Anonymized Output</h3>
              </div>
              <span class="text-xs font-semibold bg-primary/10 text-primary px-2.5 py-1 rounded-full uppercase tracking-wider">Result</span>
            </div>
            <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm flex flex-col min-h-[360px] glass-panel dark:bg-slate-800">
              <div class="flex-1 p-8 flex flex-col relative overflow-hidden group">
                <div id="resultBox" class="flex-1 bg-slate-50 dark:bg-slate-900 rounded-lg flex flex-col items-center justify-center gap-4 text-center img-box p-8">
                  <span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span>
                  <p class="text-xs font-medium px-12 text-slate-400">Processed image<br>will appear here<br>after clicking 'Anonymize'</p>
                </div>
              </div>
              <div class="px-6 h-16 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-end items-center">
                <button id="downloadBtn" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-500 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold cursor-not-allowed pointer-events-none focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900" disabled>
                  <span class="material-symbols-outlined text-[20px]">download</span>
                  Download Result
                </button>
              </div>
              
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 lg:p-8 shadow-sm glass-panel dark:bg-slate-800">
          <div class="flex flex-col lg:flex-row items-start gap-8 lg:justify-between">
            <div class="flex flex-col md:flex-row items-start gap-6 w-full lg:w-auto">
              <div class="flex flex-col gap-1.5 w-full md:w-56">
                <label class="control-label text-xs font-bold text-slate-500 uppercase tracking-wider">Anonymization Type</label>
                <div id="typeSelectWrapper" class="relative">
                  <input id="typeSelect" type="hidden" value="blur" />
                  <button id="typeSelectBtn" type="button" class="w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-100 border rounded-lg py-3 pl-3 pr-10 text-sm font-medium focus:ring-2 focus:ring-primary focus:border-primary transition-all relative flex items-center" aria-expanded="false" aria-haspopup="listbox" aria-controls="typeMenu">
                    <span id="typeSelectText">Gaussian Blur (Default)</span>
                    <span class="material-symbols-outlined select-arrow text-slate-500 dark:text-slate-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">expand_more</span>
                  </button>
                  <ul id="typeMenu" role="listbox" aria-label="Anonymization Type">
                    <li role="option" tabindex="0" data-value="blur">Gaussian Blur (Default)</li>
                    <li role="option" tabindex="0" data-value="pixelate">Pixelation Grid</li>
                    <li role="option" tabindex="0" data-value="black_bar">Censored Black Bar</li>
                  </ul>
                </div>
              </div>
              <div class="flex flex-col gap-1.5 w-full md:w-40">
                <label class="control-label text-xs font-bold text-slate-500 uppercase tracking-wider">Intensity</label>
                <div class="flex items-center gap-2 py-3">
                  <input id="intensityRange" class="flex-1 accent-primary h-1.5 bg-slate-200 rounded-full cursor-pointer" max="100" min="5" type="range" value="30"/>
                  <span id="intensityLabel" class="text-xs font-bold text-slate-900 dark:text-slate-100 w-10">30%</span>
                </div>
              </div>
              <div class="flex flex-col gap-1.5 w-full md:w-64">
                <label class="control-label text-xs font-bold text-slate-500 uppercase tracking-wider">Fast Mode</label>
                <div class="flex items-center gap-6 py-3">
                  <input id="fastModeToggle" type="checkbox" class="focus:outline-none focus:ring-0 appearance-none"/>
                  <span class="text-[15px] text-slate-600 dark:text-slate-300 whitespace-nowrap">Faster result, lower quality</span>
                </div>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto">
              <button id="anonymizeBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-8 py-4 bg-primary hover:bg-primary/90 text-on-primary rounded-xl font-bold transition-all shadow-lg shadow-primary/20 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900 border border-transparent">
                <img id="anonymizeIcon" src="/web/anonymizer%20button%20icon.png" class="h-5 w-5 object-contain block" alt="Anonymize" />
                <span id="anonymizeText" class="leading-none">Anonymize Now</span>
              </button>
              <button id="clearBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200 rounded-xl font-bold transition-all dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900">
                <span class="material-symbols-outlined text-[20px]">restart_alt</span>
                Clear
              </button>
            </div>
          </div>
        </div>
      </main>
      <div id="toastContainer" class="fixed top-20 right-8 z-[100] flex flex-col gap-4 w-80 pointer-events-none" role="region" aria-live="polite" aria-label="Notifications"></div>
      <!--
      <section class="max-w-[1200px] mx-auto w-full px-6 lg:px-10 pb-10">
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 shadow-sm">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">Logs</h4>
            <div class="flex gap-2">
              <button id="copyLogsBtn" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-900 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 rounded-md text-xs font-bold">Copy</button>
              <button id="clearLogsBtn" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-900 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 rounded-md text-xs font-bold">Clear</button>
            </div>
          </div>
          <div id="errorLog" class="log-panel text-xs font-mono text-slate-700 dark:text-slate-200"></div>
        </div>
      </section>
      -->
    </div>
    <script>
      const themeBtn = document.getElementById('themeBtn');
      const themeIcon = document.getElementById('themeIcon');
      const themeHeaderToggle = document.getElementById('themeHeaderToggle');
      const fileInput = document.getElementById('fileInput');
      const browseBtn = document.getElementById('browseBtn');
      const dropArea = document.getElementById('dropArea');
      const statusText = document.getElementById('statusText');
      const resultBox = document.getElementById('resultBox');
      const anonymizeBtn = document.getElementById('anonymizeBtn');
      const clearBtn = document.getElementById('clearBtn');
      const intensityRange = document.getElementById('intensityRange');
      const intensityLabel = document.getElementById('intensityLabel');
      const typeSelect = document.getElementById('typeSelect');
      const downloadBtn = document.getElementById('downloadBtn');
      const tabImage = document.getElementById('tabImage');
      const tabVideo = document.getElementById('tabVideo');
      const sourceTabs = document.getElementById('sourceTabs');
      const tabIndicator = document.getElementById('tabIndicator');
      const tabImageMobile = document.getElementById('tabImageMobile');
      const tabVideoMobile = document.getElementById('tabVideoMobile');
      const mobileSourceTabs = document.getElementById('mobileSourceTabs');
      const tabIndicatorMobile = document.getElementById('tabIndicatorMobile');
      const logView = document.getElementById('errorLog');
      const copyLogsBtn = document.getElementById('copyLogsBtn');
      const clearLogsBtn = document.getElementById('clearLogsBtn');
      const inputHeading = document.getElementById('inputHeading');
      

      let selectedFile = null;
      let resultBlobUrl = null;
      let reprocTimer = null;
      let processingAnimTimer = null;
      let processingAnimStep = 0;
      let progressTimer = null;
      let progressValue = 0;
      let progressStartTime = 0;
      let processingToast = null;
      let lastProgressDisplay = 0;
      function setTabsInteractivity(enabled) {
        const st = document.getElementById('sourceTabs');
        const mst = document.getElementById('mobileSourceTabs');
        if (enabled) {
          if (st) { st.style.pointerEvents = 'auto'; st.removeAttribute('aria-disabled'); }
          if (mst) { mst.style.pointerEvents = 'auto'; mst.removeAttribute('aria-disabled'); }
        } else {
          if (st) { st.style.pointerEvents = 'none'; st.setAttribute('aria-disabled','true'); }
          if (mst) { mst.style.pointerEvents = 'none'; mst.setAttribute('aria-disabled','true'); }
        }
      }
      function lockButtonSize(btn) {
        if (!btn) return;
        const w = Math.round(btn.offsetWidth);
        const h = Math.round(btn.offsetHeight);
        btn.style.minWidth = w + 'px';
        btn.style.minHeight = h + 'px';
      }
      function equalizeButtons() {
        if (!anonymizeBtn || !clearBtn) return;
        const ah = Math.round(anonymizeBtn.offsetHeight);
        const ch = Math.round(clearBtn.offsetHeight);
        const h = Math.max(ah, ch);
        anonymizeBtn.style.minHeight = h + 'px';
        clearBtn.style.minHeight = h + 'px';
      }
      requestAnimationFrame(equalizeButtons);
      window.addEventListener('resize', () => { equalizeButtons(); });
      let busy = false;
      window.addEventListener('beforeunload', (e) => {
        if (busy || resultBlobUrl) {
          e.preventDefault();
          e.returnValue = 'Your anonymized result will be cleared if you refresh or leave.';
        }
      });
      let currentAbortController = null;
      const logs = [];
      let source = 'image';
      const MIN_PROCESS_MS = 800;
      const metricFaces = () => document.getElementById('metricFaces');
      const metricTime = () => document.getElementById('metricTime');
      const metricType = () => document.getElementById('metricType');
      const metricStatus = () => document.getElementById('metricStatus');
      const ALLOWED_IMAGE_TYPES = ['image/jpeg','image/png','image/webp','image/bmp','image/tiff'];
      const ALLOWED_IMAGE_EXT = ['.jpg','.jpeg','.png','.webp','.bmp','.tif','.tiff'];
      const ALLOWED_VIDEO_TYPES = ['video/mp4','video/webm','video/quicktime','video/x-msvideo','video/hevc'];
      const ALLOWED_VIDEO_EXT = ['.mp4','.webm','.mov','.avi','.hevc'];
      
      function extOf(name) { const i = name.lastIndexOf('.'); return i >= 0 ? name.slice(i).toLowerCase() : ''; }
      function canPlayVideoType(t) { const v = document.createElement('video'); return !!(v.canPlayType && v.canPlayType(t)); }
      function startProgress(kind) {
        progressValue = 0;
        lastProgressDisplay = 0;
        progressStartTime = performance.now();
        const label = kind === 'video' ? 'Processing video' : 'Processing image';
        resultBox.innerHTML = `
          <div class="w-full mx-auto flex flex-col items-center justify-center gap-3 p-4" style="width: min(100%, 260px);">
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">${label}</p>
            <div id="progressBarWrap" class="relative w-full h-2 rounded-full bg-slate-200 dark:bg-slate-800 overflow-hidden border border-slate-300 dark:border-slate-700">
              <div id="progressBarInner" class="h-full bg-primary transition-all" style="width: 0%;"></div>
              <div id="progressStripe" class="absolute inset-0 rounded-full bar-stripes" style="display:none;"></div>
            </div>
            <span id="progressPercent" class="text-xs font-bold text-slate-700 dark:text-slate-300">0%</span>
          </div>
        `;
        if (progressTimer) { clearInterval(progressTimer); }
        progressTimer = setInterval(() => {
          const step = progressValue < 80 ? 5 : 2;
          progressValue = Math.min(95, progressValue + step);
          const bar = document.getElementById('progressBarInner');
          const pct = document.getElementById('progressPercent');
          const stripe = document.getElementById('progressStripe');
          const disp = Math.max(lastProgressDisplay, progressValue);
          lastProgressDisplay = disp;
          if (bar) bar.style.width = disp + '%';
          if (pct) pct.textContent = disp >= 95 ? 'Finalizing…' : Math.round(disp) + '%';
          if (stripe) stripe.style.display = progressValue >= 95 ? 'block' : 'none';
        }, 200);
      }
      function finishProgress() {
        if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
        const bar = document.getElementById('progressBarInner');
        const pct = document.getElementById('progressPercent');
        const stripe = document.getElementById('progressStripe');
        lastProgressDisplay = 100;
        if (bar) bar.style.width = '100%';
        if (pct) pct.textContent = '100%';
        if (stripe) stripe.style.display = 'none';
        setTabsInteractivity(true);
      }
      function readHead(file, n = 32) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onerror = () => reject(new Error('Read error'));
          r.onload = () => resolve(new Uint8Array(r.result));
          r.readAsArrayBuffer(file.slice(0, n));
        });
      }
      async function sniffImage(file) {
        try {
          const b = await readHead(file, 16);
          if (b.length >= 2 && b[0] === 0xFF && b[1] === 0xD8) return true;
          if (b.length >= 8 && b[0] === 0x89 && b[1] === 0x50 && b[2] === 0x4E && b[3] === 0x47 && b[4] === 0x0D && b[5] === 0x0A && b[6] === 0x1A && b[7] === 0x0A) return true;
          if (b.length >= 12 && String.fromCharCode(b[0],b[1],b[2],b[3]) === 'RIFF' && String.fromCharCode(b[8],b[9],b[10],b[11]) === 'WEBP') return true;
          if (b.length >= 2 && b[0] === 0x42 && b[1] === 0x4D) return true;
          if (b.length >= 4) {
            const s4 = String.fromCharCode(b[0],b[1],b[2],b[3]);
            if (s4 === 'II*\u0000' || s4 === 'MM\u0000*') return true;
          }
          return false;
        } catch { return false; }
      }
      async function sniffVideo(file) {
        try {
          const b = await readHead(file, 64);
          if (b.length >= 8 && String.fromCharCode(b[4],b[5],b[6],b[7]) === 'ftyp') return true;
          const s = String.fromCharCode(...b);
          if (s.toLowerCase().includes('webm')) return true;
          if (b.length >= 12 && String.fromCharCode(b[0],b[1],b[2],b[3]) === 'RIFF' && String.fromCharCode(b[8],b[9],b[10],b[11]) === 'AVI ') return true;
          return false;
        } catch { return false; }
      }
      async function validateFile(file, mode) {
        if (!file) return { ok: false, msg: 'No file provided' };
        const ext = extOf(file.name);
        if (mode === 'image') {
          if (!ALLOWED_IMAGE_TYPES.includes(file.type)) return { ok: false, msg: 'Unsupported image type' };
          if (!ALLOWED_IMAGE_EXT.includes(ext)) return { ok: false, msg: 'Unsupported image extension' };
          if (file.size > 10 * 1024 * 1024) return { ok: false, msg: 'File too large (max 10MB)' };
          const ok = await sniffImage(file);
          if (!ok) return { ok: false, msg: 'Invalid or corrupted image' };
          return { ok: true };
        } else {
          if (!ALLOWED_VIDEO_TYPES.includes(file.type)) return { ok: false, msg: 'Unsupported video type' };
          if (!ALLOWED_VIDEO_EXT.includes(ext)) return { ok: false, msg: 'Unsupported video extension' };
          if (file.size > 200 * 1024 * 1024) return { ok: false, msg: 'Video too large (max 200MB)' };
          const ok = await sniffVideo(file);
          if (!ok) return { ok: false, msg: 'Invalid or corrupted video' };
          try {
            const fd = new FormData();
            fd.append('video', file);
            const resp = await fetch(`${API_BASE}/api/validate_video`, { method: 'POST', body: fd });
            if (!resp.ok) {
              return { ok: false, msg: 'Video validation failed' };
            }
            const j = await resp.json();
            if (!j || j.faces === undefined) return { ok: false, msg: 'Video validation failed' };
            if (Number(j.faces || 0) <= 0) return { ok: false, msg: 'No faces detected in the first seconds' };
          } catch {
            return { ok: false, msg: 'Unable to validate video' };
          }
          return { ok: true };
        }
      }

      function applyTheme(t) {
        const isDark = t === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        themeIcon.textContent = isDark ? 'dark_mode' : 'light_mode';
      }
      function initTheme() {
        const saved = localStorage.getItem('theme');
        let mode = saved;
        if (!mode) {
          const prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          mode = prefers ? 'dark' : 'light';
        }
        applyTheme(mode);
      }
      if (window.matchMedia) {
        const mm = window.matchMedia('(prefers-color-scheme: dark)');
        mm.addEventListener('change', (e) => {
          const saved = localStorage.getItem('theme');
          if (!saved) applyTheme(e.matches ? 'dark' : 'light');
        });
      }
      themeBtn.addEventListener('click', () => {
        const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        localStorage.setItem('theme', next);
        applyTheme(next);
        themeIcon.classList.remove('sun-toggle-anim','moon-toggle-anim');
        void themeIcon.offsetWidth;
        themeIcon.classList.add(next === 'dark' ? 'moon-toggle-anim' : 'sun-toggle-anim');
        themeBtn.classList.add('theme-ripple');
        setTimeout(() => themeBtn.classList.remove('theme-ripple'), 420);
      });
      if (themeHeaderToggle) {
        try {
          themeHeaderToggle.style.pointerEvents = 'none';
          themeHeaderToggle.setAttribute('aria-disabled', 'true');
        } catch {}
      }
      initTheme();
      function bindUploadControls() {
        const btn = document.getElementById('browseBtn');
        const input = document.getElementById('fileInput');
        const vbtn = document.getElementById('browseVideoBtn');
        const vinput = document.getElementById('videoInput');
        if (source === 'image') {
          if (btn) btn.addEventListener('click', () => {
            if (busy) { toast('Uploads are disabled during processing', 'info', 2500); return; }
            if (input) input.click();
          });
          if (input) input.addEventListener('change', (e) => {
            if (busy) { try { e.target.value = ''; } catch {} toast('Uploads are disabled during processing', 'info', 2500); return; }
            handleFiles(e.target.files);
          });
        } else if (source === 'video') {
          if (vbtn) vbtn.addEventListener('click', () => {
            if (busy) { toast('Uploads are disabled during processing', 'info', 2500); return; }
            if (vinput) vinput.click();
          });
          if (vinput) vinput.addEventListener('change', (e) => {
            if (busy) { try { e.target.value = ''; } catch {} toast('Uploads are disabled during processing', 'info', 2500); return; }
            handleFiles(e.target.files);
          });
        }
        if (dropArea) {
          const onDrag = (ev) => { ev.preventDefault(); ev.stopPropagation(); if (busy) return; dropArea.classList.add('drop-active'); };
          dropArea.addEventListener('dragenter', onDrag);
          dropArea.addEventListener('dragover', onDrag);
          dropArea.addEventListener('dragleave', (ev) => { ev.preventDefault(); ev.stopPropagation(); dropArea.classList.remove('drop-active'); });
          dropArea.addEventListener('drop', async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            dropArea.classList.remove('drop-active');
            const dt = ev.dataTransfer;
            if (!dt || !dt.files || !dt.files.length) return;
            if (busy) { toast('Uploads are disabled during processing', 'info', 2500); return; }
            await handleFiles(dt.files);
          });
        }
      }
      bindUploadControls();
      setAnonymizeEnabled(false, false);

      function logMsg(msg, level = 'info') {}
      /* window.addEventListener('error', (e) => logMsg(e.message, 'error'));
      window.addEventListener('unhandledrejection', (e) => logMsg(String(e.reason), 'error'));
      if (copyLogsBtn) copyLogsBtn.addEventListener('click', async () => {});
      if (clearLogsBtn) clearLogsBtn.addEventListener('click', () => {}); */

      ;['dragenter', 'dragover', 'dragleave'].forEach(eventName => {
        if (dropArea) {
          dropArea.addEventListener(eventName, (e) => e.preventDefault());
          dropArea.addEventListener(eventName, (e) => e.stopPropagation());
        }
      });
      function positionTabIndicator(btn) {
        if (!btn) return;
        const container = btn.closest('#mobileSourceTabs') || btn.closest('#sourceTabs');
        const indicator = container && container.id === 'mobileSourceTabs' ? tabIndicatorMobile : tabIndicator;
        if (!indicator || !container) return;
        const rectBtn = btn.getBoundingClientRect();
        const rectCont = container.getBoundingClientRect();
        const inset = 2; // keep indicator slightly inset for consistent look on narrow devices
        const left = Math.round(rectBtn.left - rectCont.left) + inset;
        const top = Math.round(rectBtn.top - rectCont.top) + inset;
        const width = Math.round(rectBtn.width) - inset * 2;
        const height = Math.round(rectBtn.height) - inset * 2;
        requestAnimationFrame(() => {
          indicator.style.left = `${left}px`;
          indicator.style.top = `${top}px`;
          indicator.style.width = `${width}px`;
          indicator.style.height = `${height}px`;
        });
      }
      function recalcTabIndicators() {
        try {
          positionTabIndicator(source === 'image' ? tabImage : tabVideo);
          const mobileVisible =
            mobileSourceTabs &&
            window.matchMedia('(max-width: 640px)').matches &&
            getComputedStyle(mobileSourceTabs).display !== 'none';
          if (mobileVisible && tabImageMobile && tabVideoMobile) {
            positionTabIndicator(source === 'image' ? tabImageMobile : tabVideoMobile);
          }
        } catch {}
      }
      function updateMetrics({ faces = null, ms = null, type = '', status = '' }) {
        if (metricFaces()) metricFaces().textContent = faces === null ? '—' : String(faces);
        if (metricTime()) metricTime().textContent = ms === null ? '—' : `${Math.round(ms)} ms`;
        if (metricType()) metricType().textContent = type ? type.replace('_',' ') : '—';
        if (metricStatus()) metricStatus().textContent = status || '—';
      }
      function setSource(next) {
        if (busy) {
          processingToast = toast('Processing in progress — switching tabs disabled until completion.', 'info', 0, true);
          return;
        }
        if (resultBlobUrl && downloadBtn && !downloadBtn.hasAttribute('disabled')) {
          const proceed = window.confirm('A result is ready. Switching tabs will clear the result. Continue?');
          if (!proceed) return;
          try { URL.revokeObjectURL(resultBlobUrl); } catch {}
          resultBlobUrl = null;
          setDownloadEnabled(false);
        }
        // abort any in-flight processing and reset timers
        if (reprocTimer) { clearTimeout(reprocTimer); reprocTimer = null; }
        if (currentAbortController) { try { currentAbortController.abort(); } catch {} currentAbortController = null; }
        if (progressTimer) { try { clearInterval(progressTimer); } catch {} progressTimer = null; }
        busy = false;
        
        // clear selected data
        selectedFile = null;
        // switch source and rebuild UI
        source = next;
        const imgActive = next === 'image';
        const vidActive = next === 'video';
        dropArea.innerHTML = imgActive ? renderDropAreaContent() : renderVideoPlaceholderContent();
        bindUploadControls();
        tabImage.className = imgActive
          ? 'px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center'
          : 'px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center';
        tabVideo.className = vidActive
          ? 'px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center'
          : 'px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center';
        positionTabIndicator(imgActive ? tabImage : tabVideo);
        if (tabImageMobile && tabVideoMobile) {
          tabImageMobile.className = imgActive
            ? 'px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center'
            : 'px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center';
          tabVideoMobile.className = vidActive
            ? 'px-6 h-10 rounded-full font-bold text-sm leading-none text-on-primary relative z-10 transition-colors flex items-center'
            : 'px-6 h-10 rounded-full font-bold text-sm leading-none text-slate-700 dark:text-slate-300 relative z-10 transition-colors flex items-center';
          positionTabIndicator(imgActive ? tabImageMobile : tabVideoMobile);
        }
        statusText.textContent = 'No file selected';
        if (inputHeading) {
          inputHeading.textContent = imgActive ? 'Input Images' : 'Input Video';
        }
        if (imgActive) {
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed image<br>will appear here<br>after clicking 'Anonymize'</p>`;
        } else {
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed video<br>will appear here<br>after clicking 'Anonymize'</p>`;
        }
        setDownloadEnabled(false);
        setAnonymizeEnabled(false, false);
        updateMetrics({ faces: null, ms: null, type: '', status: '' });
      }
      setSource('image');
      tabImage.addEventListener('click', () => setSource('image'));
      tabVideo.addEventListener('click', () => setSource('video'));
      if (tabImageMobile) tabImageMobile.addEventListener('click', () => setSource('image'));
      if (tabVideoMobile) tabVideoMobile.addEventListener('click', () => setSource('video'));
      window.addEventListener('resize', () => setTimeout(recalcTabIndicators, 0));
      window.addEventListener('orientationchange', () => setTimeout(recalcTabIndicators, 0));
      window.addEventListener('load', () => { setTimeout(recalcTabIndicators, 0); setTimeout(recalcTabIndicators, 300); });
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn) { try { btn.blur(); } catch {} }
      });
      function applyFullscreenClass() {
        try {
          const isMobile = window.matchMedia('(max-width: 640px)').matches;
          const isFS = !!document.fullscreenElement || ((window.innerHeight >= (screen.height - 1)) && (window.innerWidth >= (screen.width - 1)));
          document.body.classList.toggle('fullscreen', !isMobile && isFS);
        } catch {}
      }
      document.addEventListener('fullscreenchange', applyFullscreenClass);
      window.addEventListener('resize', applyFullscreenClass);
      applyFullscreenClass();
      const STATIC_BASE = (function() {
        try {
          const host = String(location.hostname || '');
          return host.endsWith('github.io') ? '' : '/web';
        } catch { return '/web'; }
      })();
      const API_BASE = (function() {
        try {
          const v = localStorage.getItem('api_base') || '';
          return v ? v.replace(/\/+$/,'') : '';
        } catch { return ''; }
      })();
      (function ensureLogo() {
        const img = document.getElementById('headerLogo');
        const container = document.getElementById('logoContainer');
        if (!img || !container) return;
        img.addEventListener('error', () => {
          img.onerror = null;
          container.innerHTML = '<span class="material-symbols-outlined text-primary">face_retouching_off</span>';
        });
      })();
      (function ensureAnonymizeIcon() {
        const icon = document.getElementById('anonymizeIcon');
        if (!icon) return;
        icon.addEventListener('error', () => {
          try {
            const btn = document.getElementById('anonymizeBtn');
            if (btn) btn.innerHTML = `<span class="material-symbols-outlined">auto_fix_high</span> Anonymize Now`;
          } catch {}
        });
        try {
          const base = `${STATIC_BASE}/anonymizer%20button%20icon.png`;
          icon.src = `${base}?v=${Date.now()}`;
        } catch {}
      })();
      async function refreshLogo() {
        const img = document.getElementById('headerLogo');
        if (!img) return;
        const base = `${STATIC_BASE}/logo.png`;
        const v = Date.now();
        img.src = `${base}?v=${v}`;
      }
      refreshLogo();
      (function fixFavicon() {
        try {
          const links = [
            document.querySelector('link[rel="icon"]#favicon'),
            document.querySelector('link[rel="shortcut icon"]'),
            document.querySelector('link[rel="apple-touch-icon"]'),
          ].filter(Boolean);
          for (const el of links) {
            el.href = `${STATIC_BASE}/logo-white.png`;
          }
        } catch {}
      })();

      intensityRange.addEventListener('input', () => {
        updateIntensityUI();
        const val = String(intensityRange.value);
        if (statusText) statusText.textContent = `Intensity: ${val}%`;
        if (resultBlobUrl) setDownloadEnabled(false);
      });
      intensityRange.addEventListener('change', () => {
        updateIntensityUI();
        const val = String(intensityRange.value);
        if (statusText) statusText.textContent = `Intensity: ${val}%`;
      });
      function updateIntensityUI() {
        const v = Number(intensityRange.value);
        intensityLabel.textContent = v + '%';
        const min = Number(intensityRange.min || 0);
        const max = Number(intensityRange.max || 100);
        const ratio = Math.max(0, Math.min(1, (v - min) / (max - min)));
        const rect = intensityRange.getBoundingClientRect();
        const width = Math.max(0, rect.width || intensityRange.offsetWidth || 0);
        const x = Math.round(ratio * width);
        const isDark = document.documentElement.classList.contains('dark');
        const base = isDark ? '#374151' : '#e5e7eb';
        const pri = isDark ? '#ffffff' : '#000000';
        intensityRange.style.background = `linear-gradient(to right, ${pri} ${x}px, ${base} ${x}px)`;
      }
      const typeSelectWrapper = document.getElementById('typeSelectWrapper');
      const typeSelectBtn = document.getElementById('typeSelectBtn');
      const typeSelectText = document.getElementById('typeSelectText');
      const typeMenu = document.getElementById('typeMenu');
      const TYPE_LABELS = { blur: 'Gaussian Blur (Default)', pixelate: 'Pixelation Grid', black_bar: 'Censored Black Bar' };
      typeSelect.addEventListener('change', () => {
        const txt = TYPE_LABELS[typeSelect.value] || typeSelect.value;
        statusText.textContent = `Type: ${txt}`;
      });
      if (typeSelectWrapper && typeSelectBtn && typeMenu && typeSelectText && typeSelect) {
        const closeMenu = () => { typeSelectWrapper.classList.remove('select-open'); typeSelectBtn.setAttribute('aria-expanded','false'); };
        const openMenu = () => { typeSelectWrapper.classList.add('select-open'); typeSelectBtn.setAttribute('aria-expanded','true'); };
        typeSelectBtn.addEventListener('click', () => {
          if (typeSelectWrapper.classList.contains('select-open')) closeMenu(); else openMenu();
        });
        document.addEventListener('mousedown', (e) => { if (!typeSelectWrapper.contains(e.target)) closeMenu(); });
        document.addEventListener('touchstart', (e) => { if (!typeSelectWrapper.contains(e.target)) closeMenu(); }, { passive: true });
        document.addEventListener('pointerdown', (e) => { if (!typeSelectWrapper.contains(e.target)) closeMenu(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
        typeMenu.querySelectorAll('li').forEach(li => {
          li.addEventListener('click', () => {
            const val = li.getAttribute('data-value');
            typeSelect.value = val;
            typeSelectText.textContent = TYPE_LABELS[val] || val;
            typeSelect.dispatchEvent(new Event('change'));
            closeMenu();
          });
          li.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              li.click();
            }
          });
        });
      }
      updateIntensityUI();
      window.addEventListener('resize', updateIntensityUI);
      if (themeBtn) {
        themeBtn.addEventListener('click', () => {
          setTimeout(updateIntensityUI, 0);
        });
      }
      

      clearBtn.addEventListener('click', () => {
        try {
          const icon = clearBtn.querySelector('.material-symbols-outlined');
          if (icon) {
            icon.classList.remove('spin-once');
            void icon.offsetWidth;
            icon.classList.add('spin-once');
          }
        } catch {}
        const f = document.getElementById('fastModeToggle');
        const isDefault =
          selectedFile === null &&
          resultBlobUrl === null &&
          !busy &&
          currentAbortController === null &&
          statusText && statusText.textContent === 'No file selected' &&
          typeSelect && typeSelect.value === 'blur' &&
          intensityRange && String(intensityRange.value) === '30' &&
          (!f || f.checked === false);
        if (isDefault) {
          return;
        }
        selectedFile = null;
        if (reprocTimer) { clearTimeout(reprocTimer); reprocTimer = null; }
        if (currentAbortController) { try { currentAbortController.abort(); } catch {} currentAbortController = null; }
        if (progressTimer) { try { clearInterval(progressTimer); } catch {} progressTimer = null; }
        if (processingAnimTimer) { try { clearInterval(processingAnimTimer); } catch {} processingAnimTimer = null; }
        processingAnimStep = 0;
        busy = false;
        setTabsInteractivity(true);
        if (processingToast && typeof processingToast.remove === 'function') { try { processingToast.remove(); } catch {} processingToast = null; }
        // reset button visuals first, then disable until next upload
        setAnonymizeEnabled(true, false);
        dropArea.innerHTML = source === 'image' ? renderDropAreaContent() : renderVideoPlaceholderContent();
        bindUploadControls();
        if (source === 'image') {
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed image<br>will appear here<br>after clicking 'Anonymize'</p>`;
        } else {
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed video<br>will appear here<br>after clicking 'Anonymize'</p>`;
        }
        statusText.textContent = 'No file selected';
        
        setDownloadEnabled(false);
        setAnonymizeEnabled(false, false);
        updateMetrics({ faces: null, ms: null, type: '', status: '' });
        // reset controls
        if (typeSelect && typeSelectText) {
          typeSelect.value = 'blur';
          typeSelectText.textContent = 'Gaussian Blur (Default)';
        }
        if (intensityRange && intensityLabel) {
          intensityRange.value = 30;
          intensityLabel.textContent = '30%';
          updateIntensityUI();
        }
        try {
          const f = document.getElementById('fastModeToggle');
          if (f) f.checked = false;
        } catch {}
        if (resultBlobUrl) { URL.revokeObjectURL(resultBlobUrl); resultBlobUrl = null; }
        toast('Cleared successfully', 'success', 2400);
      });

      anonymizeBtn.addEventListener('click', () => source === 'image' ? runAnonymize() : runAnonymizeVideo());
      async function runAnonymize() {
        if (busy) return;
        if (!selectedFile) { toast('Please upload an image first', 'warning', 2000); return; }
        let start = 0;
        let success = false;
        let slowTimer = null;
        let networkTimer = null;
        try {
          busy = true;
          // server-side validation for faces to avoid showing progress on errors
          const vfd = new FormData();
          vfd.append('image', selectedFile);
          const vresp = await fetch(`${API_BASE}/api/validate_image`, { method: 'POST', body: vfd });
          if (!vresp.ok) {
            setAnonymizeEnabled(true, false);
            busy = false;
            toast('No faces detected or invalid image', 'warning', 4000);
            return;
          }
          const vj = await vresp.json();
          if (!vj.ok || Number(vj.faces || 0) <= 0) {
            setAnonymizeEnabled(true, false);
            busy = false;
            toast('No faces found', 'warning', 4000);
            return;
          }
          setAnonymizeEnabled(false, true);
          startProgress('image');
          start = performance.now();
          const snapType = String(typeSelect.value);
          const snapIntensity = String(intensityRange.value);
          slowTimer = setTimeout(() => {
            try {
              const f = document.getElementById('fastModeToggle');
              if (busy && (!f || !f.checked)) {
                toast("This is taking a while. Enable Fast Mode for quicker results (lower quality).", 'info', 8000);
              }
            } catch {}
          }, 60000);
          const fd = new FormData();
          fd.append('image', selectedFile);
          fd.append('type', snapType);
          fd.append('intensity', snapIntensity);
          currentAbortController = new AbortController();
          networkTimer = setTimeout(() => {
            try { if (currentAbortController) currentAbortController.abort(); } catch {}
          }, 120000);
          const resp = await fetch(`${API_BASE}/api/anonymize`, { method: 'POST', body: fd, signal: currentAbortController.signal });
          if (!resp.ok) {
            const ct = resp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const j = await resp.json();
              throw new Error(j && j.error ? j.error : 'Image processing failed');
            }
            throw new Error('Image processing failed');
          }
          const blob = await resp.blob();
          if (resultBlobUrl) { URL.revokeObjectURL(resultBlobUrl); }
          resultBlobUrl = URL.createObjectURL(blob);
          success = true;
        } catch (err) {
          if (err && err.name === 'AbortError') {
            // cancelled
          } else {
            logMsg(err && (err.stack || err.message) ? (err.stack || err.message) : String(err), 'error');
            toast(err && err.message ? err.message : 'Error processing image', 'error', 6000);
          }
        } finally {
          if (slowTimer) { clearTimeout(slowTimer); slowTimer = null; }
          if (networkTimer) { clearTimeout(networkTimer); networkTimer = null; }
          currentAbortController = null;
          const end = performance.now();
          const diff = MIN_PROCESS_MS - (end - start);
          if (diff > 0) { await new Promise(r => setTimeout(r, diff)); }
          if (success && resultBlobUrl) {
            finishProgress();
            await new Promise(r => setTimeout(r, 300));
            resultBox.innerHTML = `<img class="bg-blur" src="${resultBlobUrl}" alt=""><img class="img-main" src="${resultBlobUrl}" alt="Anonymized">`;
            setDownloadEnabled(true);
            toast('Anonymized image ready', 'success', 2000);
          }
          busy = false;
          setAnonymizeEnabled(true, false);
          setSettingsEnabled(true);
        }
      }
      async function runAnonymizeVideo() {
        if (busy) return;
        if (!selectedFile) { toast('Please select a video first', 'warning', 2000); return; }
        let start = 0;
        let success = false;
        let slowTimer = null;
        let jobPollTimer = null;
        let jobId = null;
        let networkTimer = null;
        try {
          busy = true;
          setAnonymizeEnabled(false, true);
          startProgress('video');
          start = performance.now();
          const snapType = String(typeSelect.value);
          const snapIntensity = String(intensityRange.value);
          let snapFast = '0';
          try {
            const f = document.getElementById('fastModeToggle');
            snapFast = f && f.checked ? '1' : '0';
          } catch {}
          const fd = new FormData();
          fd.append('video', selectedFile);
          fd.append('type', snapType);
          fd.append('intensity', snapIntensity);
          fd.append('fast_mode', snapFast);
          currentAbortController = new AbortController();
          networkTimer = setTimeout(() => {
            try { if (currentAbortController) currentAbortController.abort(); } catch {}
          }, 120000);
          const startResp = await fetch(`${API_BASE}/api/start_job_video`, { method: 'POST', body: fd, signal: currentAbortController.signal });
          if (!startResp.ok) {
            const ct = startResp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const j = await startResp.json();
              throw new Error(j && j.error ? j.error : 'Video processing failed to start');
            }
            throw new Error('Video processing failed to start');
          }
          const j = await startResp.json();
          jobId = j && j.id ? j.id : null;
          if (!jobId) throw new Error('Unable to start progress job');
          slowTimer = setTimeout(() => {
            try {
              const f = document.getElementById('fastModeToggle');
              if (busy && (!f || !f.checked)) {
                toast("If processing feels too slow, cancel and enable Fast Mode for quicker results (lower quality).", 'info', 8000);
              }
            } catch {}
          }, 60000);
          await new Promise((resolve, reject) => {
            jobPollTimer = setInterval(async () => {
              try {
                const pr = await fetch(`${API_BASE}/api/job_progress?id=${encodeURIComponent(jobId)}`);
                if (!pr.ok) return;
                const pj = await pr.json();
                if (!pj.ok) return;
                const bar = document.getElementById('progressBarInner');
                const pct = document.getElementById('progressPercent');
                const stripe = document.getElementById('progressStripe');
                const p = Number(pj.percent || 0);
                const next = Math.max(Number(progressValue || 0), p);
                progressValue = next;
                const disp = Math.max(lastProgressDisplay, next);
                lastProgressDisplay = disp;
                if (bar) bar.style.width = `${disp}%`;
                if (pct) pct.textContent = disp >= 95 && !pj.done ? 'Finalizing…' : `${Math.round(disp)}%`;
                if (stripe) stripe.style.display = next >= 95 && !pj.done ? 'block' : 'none';
                if (pj.done) {
                  if (jobPollTimer) { clearInterval(jobPollTimer); jobPollTimer = null; }
                  if (pj.faces === 0) {
                    return reject(new Error('No faces found'));
                  }
                  const dl = await fetch(`${API_BASE}/api/job_download?id=${encodeURIComponent(jobId)}`);
                  if (!dl.ok) return reject(new Error('Download not ready'));
                  const blob = await dl.blob();
                  if (resultBlobUrl) { URL.revokeObjectURL(resultBlobUrl); }
                  resultBlobUrl = URL.createObjectURL(blob);
                  success = true;
                  return resolve(true);
                }
              } catch (e) {
                // swallow transient errors
              }
            }, 400);
          });
        } catch (err) {
          if (err && err.name === 'AbortError') {
            // cancelled
          } else {
            logMsg(err && (err.stack || err.message) ? (err.stack || err.message) : String(err), 'error');
            toast(err && err.message ? err.message : 'Error processing video', 'error', 6000);
          }
        } finally {
          if (slowTimer) { clearTimeout(slowTimer); slowTimer = null; }
          if (jobPollTimer) { clearInterval(jobPollTimer); jobPollTimer = null; }
           if (networkTimer) { clearTimeout(networkTimer); networkTimer = null; }
          currentAbortController = null;
          const end = performance.now();
          const diff = MIN_PROCESS_MS - (end - start);
          if (diff > 0) { await new Promise(r => setTimeout(r, diff)); }
          if (success && resultBlobUrl) {
            finishProgress();
            await new Promise(r => setTimeout(r, 300));
            resultBox.innerHTML = `<video class="img-main w-full h-full" controls preload="metadata" playsinline>
              <source src="${resultBlobUrl}" type="video/mp4">
            </video>`;
            const vid = resultBox.querySelector('video');
            vid.addEventListener('error', () => {
              toast('Unable to preview video (codec or format not supported)', 'error', 6000);
            });
            setDownloadEnabled(true);
            toast('Anonymized video ready', 'success', 2000);
          }
          busy = false;
          setAnonymizeEnabled(true, false);
          setSettingsEnabled(true);
        }
      }
      
      function scheduleAnonymize() {
        if (!selectedFile) return;
        if (reprocTimer) clearTimeout(reprocTimer);
        reprocTimer = setTimeout(() => runAnonymize(), 250);
      }
      function setSettingsEnabled(enabled) {
        try {
          if (typeSelectBtn) {
            if (enabled) {
              typeSelectBtn.removeAttribute('disabled');
              typeSelectBtn.style.pointerEvents = 'auto';
              typeSelectBtn.setAttribute('aria-expanded','false');
            } else {
              typeSelectBtn.setAttribute('disabled','');
              typeSelectBtn.style.pointerEvents = 'none';
              typeSelectBtn.setAttribute('aria-expanded','false');
              if (typeSelectWrapper) typeSelectWrapper.classList.remove('select-open');
            }
          }
          if (intensityRange) {
            if (enabled) {
              intensityRange.removeAttribute('disabled');
              intensityRange.style.pointerEvents = 'auto';
            } else {
              intensityRange.setAttribute('disabled','');
              intensityRange.style.pointerEvents = 'none';
            }
          }
          const fmt = document.getElementById('fastModeToggle');
          if (fmt) {
            if (enabled) {
              fmt.removeAttribute('disabled');
              fmt.style.pointerEvents = 'auto';
            } else {
              fmt.setAttribute('disabled','');
              fmt.style.pointerEvents = 'none';
            }
          }
        } catch {}
      }
      function setUploadEnabled(enabled) {
        try {
          const btn = document.getElementById('browseBtn');
          const input = document.getElementById('fileInput');
          const vbtn = document.getElementById('browseVideoBtn');
          const vinput = document.getElementById('videoInput');
          const area = document.getElementById('dropArea');
          [btn, vbtn].forEach(el => {
            if (!el) return;
            if (enabled) {
              el.removeAttribute('disabled');
              el.style.pointerEvents = 'auto';
              el.classList.remove('cursor-not-allowed','opacity-50');
            } else {
              el.setAttribute('disabled','');
              el.style.pointerEvents = 'none';
              el.classList.add('cursor-not-allowed','opacity-50');
            }
          });
          [input, vinput].forEach(el => {
            if (!el) return;
            if (enabled) {
              el.removeAttribute('disabled');
            } else {
              el.setAttribute('disabled','');
            }
          });
          if (area) {
            area.style.pointerEvents = enabled ? 'auto' : 'none';
            area.classList.toggle('cursor-not-allowed', !enabled);
            area.classList.toggle('opacity-60', !enabled);
          }
        } catch {}
      }
      function setAnonymizeEnabled(enabled, processing) {
        if (enabled) {
          anonymizeBtn.disabled = false;
          anonymizeBtn.setAttribute('aria-busy', 'false');
          anonymizeBtn.style.pointerEvents = 'auto';
          anonymizeBtn.classList.remove('cursor-not-allowed','opacity-50');
          anonymizeBtn.innerHTML = `<img id="anonymizeIcon" src="/web/anonymizer%20button%20icon.png" class="h-5 w-5 object-contain block" alt="Anonymize"> <span id="anonymizeText" class="leading-none">Anonymize Now</span>`;
          if (processingAnimTimer) { clearInterval(processingAnimTimer); processingAnimTimer = null; }
          processingAnimStep = 0;
          setTabsInteractivity(true);
          setSettingsEnabled(true);
          setUploadEnabled(true);
          if (processingToast && typeof processingToast.remove === 'function') { try { processingToast.remove(); } catch {} processingToast = null; }
        } else {
          if (processing) {
            processingAnimStep = 0;
            anonymizeBtn.innerHTML = `Processing<span id="procDots"><span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>`;
            if (processingAnimTimer) { clearInterval(processingAnimTimer); }
            processingAnimTimer = setInterval(() => {
              processingAnimStep = (processingAnimStep + 1) % 3;
              const dots = anonymizeBtn.querySelectorAll('#procDots .dot');
              dots.forEach((d, i) => { d.style.visibility = i <= processingAnimStep ? 'visible' : 'hidden'; });
            }, 500);
            setTabsInteractivity(false);
            setSettingsEnabled(false);
            setUploadEnabled(false);
            processingToast = toast('Processing in progress — switching tabs and settings are disabled until completion.', 'info', 0, true);
          }
          anonymizeBtn.disabled = true;
          anonymizeBtn.setAttribute('aria-busy', 'true');
          anonymizeBtn.style.pointerEvents = 'none';
          anonymizeBtn.classList.add('cursor-not-allowed','opacity-50');
        }
      }

      

      function toast(msg, type = 'info', duration = 2000, noClose = false) {
        return showToast({ title: type === 'error' ? 'Error' : type === 'success' ? 'Success' : type === 'warning' ? 'Warning' : 'Info', message: msg, type, duration, noClose });
      }

      async function handleFiles(files) {
        if (!files || !files.length) return;
        const f = files[0];
        const mode = source === 'image' ? 'image' : 'video';
        const res = await validateFile(f, mode);
        if (!res.ok) {
          logMsg(res.msg, 'warn');
          toast(res.msg, 'warning', 5000);
          return;
        }
        selectedFile = f;
        const url = URL.createObjectURL(f);
        if (mode === 'image') {
          dropArea.innerHTML = `<img class="bg-blur" src="${url}" alt=""><img class="img-main" src="${url}" alt="Original">`;
          statusText.textContent = f.name;
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed image<br>will appear here<br>after clicking 'Anonymize'</p>`;
        } else {
          dropArea.innerHTML = `<video class="img-main w-full h-full" src="${url}" controls></video>`;
          statusText.textContent = f.name;
          resultBox.innerHTML = `<span class="material-symbols-outlined text-slate-300 text-5xl">visibility_off</span><p class="text-xs font-medium px-12 text-slate-400">Processed video<br>will appear here<br>after clicking 'Anonymize'</p>`;
        }
        setDownloadEnabled(false);
        setAnonymizeEnabled(true, false);
        const kind = mode === 'image' ? 'Image' : 'Video';
        toast(`${kind} uploaded`, 'success', 1600);
      }

      

      function renderDropAreaContent() {
        return `
          <div class="upload-circle bg-slate-200 text-slate-600 flex items-center justify-center transition-transform">
            <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
          </div>
          <div>
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Click or drag image to upload</p>
            <p class="text-xs text-slate-500 mt-1">Supports JPG, PNG, WEBP, BMP, TIFF (Max 10MB)</p>
          </div>
          <button id="browseBtn" class="mt-2 bg-primary hover:bg-primary/90 text-on-primary px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md">
            Browse Images
          </button>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
        `;
      }
      function renderVideoPlaceholderContent() {
        return `
          <div class="upload-circle bg-slate-200 text-slate-600 flex items-center justify-center">
            <span class="material-symbols-outlined text-3xl">movie_filter</span>
          </div>
          <div>
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Click or drag video to upload</p>
            <p class="text-xs text-slate-500 mt-1">Supports MP4, MOV, WEBM, AVI (Max ~200MB)</p>
          </div>
          <button id="browseVideoBtn" class="mt-2 bg-primary hover:bg-primary/90 text-on-primary px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md">
            Browse Videos
          </button>
          <input id="videoInput" type="file" accept="video/mp4,video/webm,video/quicktime,video/x-msvideo,video/hevc" class="hidden" />
        `;
      }
      
      function showToast({ title, message, type = 'info', duration = 4000, noClose = false }) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        if (type === 'warning') {
          const children = Array.from(container.children);
          for (const c of children) {
            if (c.getAttribute('data-type') === 'warning') {
              c.remove();
            }
          }
        }
        const iconMap = { success: 'check_circle', error: 'cancel', warning: 'warning', info: 'info' };
        const colorClass = type === 'success' ? { bar: 'bg-success', icon: 'text-success' } :
          type === 'error' ? { bar: 'bg-error', icon: 'text-error' } :
          type === 'warning' ? { bar: 'bg-warning', icon: 'text-warning' } :
          { bar: 'bg-info', icon: 'text-info' };
        const el = document.createElement('div');
        el.className = 'toast bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 rounded-lg p-4 ant-shadow flex items-start gap-3 relative overflow-hidden pointer-events-none toast-enter';
        el.setAttribute('role', 'alert');
        el.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
        el.setAttribute('data-type', type);
        el.innerHTML = `
          <div class="absolute top-0 left-0 w-1 h-full ${colorClass.bar}"></div>
          <span class="material-symbols-outlined ${colorClass.icon}">${iconMap[type]}</span>
          <div class="flex-1 toast-body">
            <p class="text-sm font-semibold text-gray-900 dark:text-white">${title}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${message}</p>
          </div>
        `;
        if (!noClose) {
          const btn = document.createElement('button');
          btn.className = 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200';
          btn.setAttribute('aria-label','Close notification');
          btn.innerHTML = '<span class="material-symbols-outlined text-lg">close</span>';
          el.appendChild(btn);
          try { btn.style.pointerEvents = 'auto'; } catch {}
        }
        const remove = () => {
          el.classList.remove('toast-enter','toast-enter-active');
          el.classList.add('toast-exit','toast-exit-active');
          setTimeout(() => { el.remove(); }, 200);
        };
        const closeBtn = el.querySelector('button');
        if (closeBtn && !noClose) { closeBtn.addEventListener('click', remove); }
        container.prepend(el);
        requestAnimationFrame(() => {
          el.classList.add('toast-enter-active');
        });
        let timer = null;
        const startTimer = () => {
          if (!noClose && duration && duration > 0) {
            timer = setTimeout(remove, duration);
          }
        };
        const clearTimer = () => { if (timer) { clearTimeout(timer); timer = null; } };
        el.addEventListener('mouseenter', clearTimer);
        el.addEventListener('mouseleave', startTimer);
        el.addEventListener('keydown', (e) => { if (!noClose && e.key === 'Escape') remove(); });
        el.tabIndex = 0;
        startTimer();
        const max = 4;
        const children = Array.from(container.children);
        if (children.length > max) {
          for (let i = children.length - 1; i >= max; i--) {
            children[i].remove();
          }
        }
        el.remove = remove;
        return el;
      }
      function setDownloadEnabled(enabled) {
        if (!downloadBtn) return;
        if (enabled && resultBlobUrl) {
          downloadBtn.classList.remove('cursor-not-allowed','pointer-events-none','text-slate-400','dark:text-slate-500','bg-slate-100','dark:bg-slate-800','border-slate-200','dark:border-slate-700');
          downloadBtn.classList.add('bg-primary','hover:bg-primary/90','text-on-primary','border','border-primary');
          downloadBtn.removeAttribute('disabled');
          if (processingToast && typeof processingToast.remove === 'function') { try { processingToast.remove(); } catch {} processingToast = null; }
        } else {
          downloadBtn.classList.add('cursor-not-allowed','pointer-events-none','text-slate-400','dark:text-slate-500','bg-slate-100','dark:bg-slate-800','border','border-slate-200','dark:border-slate-700');
          downloadBtn.classList.remove('bg-primary','hover:bg-primary/90','text-on-primary','border-primary');
          downloadBtn.setAttribute('disabled','');
        }
      }
      downloadBtn.addEventListener('click', () => {
        if (!resultBlobUrl || downloadBtn.hasAttribute('disabled')) return;
        logMsg('Downloading result...', 'info');
        const a = document.createElement('a');
        a.href = resultBlobUrl;
        a.download = source === 'image' ? 'anonymized.jpg' : 'anonymized.mp4';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        toast('Downloaded successfully', 'success', 1600);
      });
      function mapIntensityToBlur(percent) {
        const p = Math.max(5, Math.min(100, Number(percent)));
        return 2 + (p / 100) * 8;
      }
    </script>
  </body>
</html>
